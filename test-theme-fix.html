<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Theme Loop Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            transition: background-color 0.3s;
        }
        body.theme-light { background: #f5f5f5; color: #333; }
        body.theme-dark { background: #1a1a1a; color: #f5f5f5; }
        body.theme-cat { background: linear-gradient(135deg, #FFB6C1, #FFA07A); color: #fff; }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            font-size: 14px;
        }
        button:hover { background: #45a049; }
        button:active { transform: scale(0.95); }
        
        .stress-test { background: #ff9800; }
        .reset { background: #f44336; }
        
        #log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry { margin: 2px 0; }
        .log-error { color: #ff5555; }
        .log-success { color: #50fa7b; }
        .log-warn { color: #ffb86c; }
        
        #stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .stat-card {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }
    </style>
</head>
<body class="theme-light">
    <h1>🎨 Theme Loop Fix Test</h1>
    <p>测试主题切换是否还会导致无限循环调用</p>
    
    <div class="test-section">
        <h2>手动测试</h2>
        <button onclick="testTheme('light')">Light Theme</button>
        <button onclick="testTheme('dark')">Dark Theme</button>
        <button onclick="testTheme('cat')">Cat Theme</button>
        <button onclick="testTheme('dog')">Dog Theme</button>
        <br>
        <button class="stress-test" onclick="stressTest()">压力测试 (快速切换 50 次)</button>
        <button class="stress-test" onclick="concurrentTest()">并发测试 (同时触发 10 次)</button>
        <button class="reset" onclick="resetStats()">重置统计</button>
    </div>
    
    <div id="stats">
        <div class="stat-card">
            <div class="stat-value" id="apiCalls">0</div>
            <div class="stat-label">API 调用次数</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="themeChanges">0</div>
            <div class="stat-label">主题切换次数</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="errors">0</div>
            <div class="stat-label">错误次数</div>
        </div>
    </div>
    
    <div id="log"></div>

    <script src="js/api.js"></script>
    <script>
        let apiCalls = 0;
        let themeChanges = 0;
        let errors = 0;
        let currentTheme = 'light';
        let applyingTheme = false;
        
        const API_BASE = 'http://localhost:4000';
        window.CUTE_TODO_API_BASE = API_BASE;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            if (type === 'error') {
                errors++;
                updateStats();
            }
        }
        
        function updateStats() {
            document.getElementById('apiCalls').textContent = apiCalls;
            document.getElementById('themeChanges').textContent = themeChanges;
            document.getElementById('errors').textContent = errors;
        }
        
        function resetStats() {
            apiCalls = 0;
            themeChanges = 0;
            errors = 0;
            updateStats();
            document.getElementById('log').innerHTML = '';
            log('统计已重置', 'success');
        }
        
        async function testTheme(theme) {
            // 模拟前端防重入保护
            if (applyingTheme) {
                log(`⚠️ 主题应用中，跳过: ${theme}`, 'warn');
                return;
            }
            
            if (currentTheme === theme) {
                log(`✓ 主题已应用: ${theme}`, 'success');
                return;
            }
            
            applyingTheme = true;
            themeChanges++;
            updateStats();
            
            try {
                log(`→ 开始切换主题: ${theme}`, 'info');
                
                // 切换 UI
                document.body.className = `theme-${theme}`;
                currentTheme = theme;
                
                // 调用 API（不 await）
                if (window.CuteToDoAPI && window.CuteToDoAPI.ThemeAPI) {
                    apiCalls++;
                    updateStats();
                    
                    window.CuteToDoAPI.ThemeAPI.set(theme)
                        .then(() => {
                            log(`✓ API 调用成功: ${theme}`, 'success');
                        })
                        .catch(e => {
                            log(`✗ API 调用失败: ${e.message}`, 'error');
                        });
                } else {
                    log('⚠️ API 不可用', 'warn');
                }
                
                log(`✓ 主题已切换: ${theme}`, 'success');
            } catch (err) {
                log(`✗ 切换失败: ${err.message}`, 'error');
            } finally {
                applyingTheme = false;
            }
        }
        
        async function stressTest() {
            log('🔥 开始压力测试：快速切换 50 次', 'warn');
            const themes = ['light', 'dark', 'cat', 'dog'];
            
            for (let i = 0; i < 50; i++) {
                const theme = themes[i % themes.length];
                await testTheme(theme);
                await new Promise(resolve => setTimeout(resolve, 50)); // 50ms 间隔
            }
            
            log('✓ 压力测试完成', 'success');
        }
        
        async function concurrentTest() {
            log('🔥 开始并发测试：同时触发 10 次', 'warn');
            const promises = [];
            
            for (let i = 0; i < 10; i++) {
                promises.push(testTheme('dark'));
            }
            
            await Promise.all(promises);
            log('✓ 并发测试完成', 'success');
        }
        
        // 初始化
        log('✓ 测试页面已加载', 'success');
        log('→ 点击按钮测试主题切换', 'info');
    </script>
</body>
</html>

