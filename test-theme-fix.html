<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Theme Loop Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            transition: background-color 0.3s;
        }
        body.theme-light { background: #f5f5f5; color: #333; }
        body.theme-dark { background: #1a1a1a; color: #f5f5f5; }
        body.theme-cat { background: linear-gradient(135deg, #FFB6C1, #FFA07A); color: #fff; }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            font-size: 14px;
        }
        button:hover { background: #45a049; }
        button:active { transform: scale(0.95); }
        
        .stress-test { background: #ff9800; }
        .reset { background: #f44336; }
        
        #log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry { margin: 2px 0; }
        .log-error { color: #ff5555; }
        .log-success { color: #50fa7b; }
        .log-warn { color: #ffb86c; }
        
        #stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .stat-card {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }
    </style>
</head>
<body class="theme-light">
    <h1>ğŸ¨ Theme Loop Fix Test</h1>
    <p>æµ‹è¯•ä¸»é¢˜åˆ‡æ¢æ˜¯å¦è¿˜ä¼šå¯¼è‡´æ— é™å¾ªç¯è°ƒç”¨</p>
    
    <div class="test-section">
        <h2>æ‰‹åŠ¨æµ‹è¯•</h2>
        <button onclick="testTheme('light')">Light Theme</button>
        <button onclick="testTheme('dark')">Dark Theme</button>
        <button onclick="testTheme('cat')">Cat Theme</button>
        <button onclick="testTheme('dog')">Dog Theme</button>
        <br>
        <button class="stress-test" onclick="stressTest()">å‹åŠ›æµ‹è¯• (å¿«é€Ÿåˆ‡æ¢ 50 æ¬¡)</button>
        <button class="stress-test" onclick="concurrentTest()">å¹¶å‘æµ‹è¯• (åŒæ—¶è§¦å‘ 10 æ¬¡)</button>
        <button class="reset" onclick="resetStats()">é‡ç½®ç»Ÿè®¡</button>
    </div>
    
    <div id="stats">
        <div class="stat-card">
            <div class="stat-value" id="apiCalls">0</div>
            <div class="stat-label">API è°ƒç”¨æ¬¡æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="themeChanges">0</div>
            <div class="stat-label">ä¸»é¢˜åˆ‡æ¢æ¬¡æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="errors">0</div>
            <div class="stat-label">é”™è¯¯æ¬¡æ•°</div>
        </div>
    </div>
    
    <div id="log"></div>

    <script src="js/api.js"></script>
    <script>
        let apiCalls = 0;
        let themeChanges = 0;
        let errors = 0;
        let currentTheme = 'light';
        let applyingTheme = false;
        
        const API_BASE = 'http://localhost:4000';
        window.CUTE_TODO_API_BASE = API_BASE;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            if (type === 'error') {
                errors++;
                updateStats();
            }
        }
        
        function updateStats() {
            document.getElementById('apiCalls').textContent = apiCalls;
            document.getElementById('themeChanges').textContent = themeChanges;
            document.getElementById('errors').textContent = errors;
        }
        
        function resetStats() {
            apiCalls = 0;
            themeChanges = 0;
            errors = 0;
            updateStats();
            document.getElementById('log').innerHTML = '';
            log('ç»Ÿè®¡å·²é‡ç½®', 'success');
        }
        
        async function testTheme(theme) {
            // æ¨¡æ‹Ÿå‰ç«¯é˜²é‡å…¥ä¿æŠ¤
            if (applyingTheme) {
                log(`âš ï¸ ä¸»é¢˜åº”ç”¨ä¸­ï¼Œè·³è¿‡: ${theme}`, 'warn');
                return;
            }
            
            if (currentTheme === theme) {
                log(`âœ“ ä¸»é¢˜å·²åº”ç”¨: ${theme}`, 'success');
                return;
            }
            
            applyingTheme = true;
            themeChanges++;
            updateStats();
            
            try {
                log(`â†’ å¼€å§‹åˆ‡æ¢ä¸»é¢˜: ${theme}`, 'info');
                
                // åˆ‡æ¢ UI
                document.body.className = `theme-${theme}`;
                currentTheme = theme;
                
                // è°ƒç”¨ APIï¼ˆä¸ awaitï¼‰
                if (window.CuteToDoAPI && window.CuteToDoAPI.ThemeAPI) {
                    apiCalls++;
                    updateStats();
                    
                    window.CuteToDoAPI.ThemeAPI.set(theme)
                        .then(() => {
                            log(`âœ“ API è°ƒç”¨æˆåŠŸ: ${theme}`, 'success');
                        })
                        .catch(e => {
                            log(`âœ— API è°ƒç”¨å¤±è´¥: ${e.message}`, 'error');
                        });
                } else {
                    log('âš ï¸ API ä¸å¯ç”¨', 'warn');
                }
                
                log(`âœ“ ä¸»é¢˜å·²åˆ‡æ¢: ${theme}`, 'success');
            } catch (err) {
                log(`âœ— åˆ‡æ¢å¤±è´¥: ${err.message}`, 'error');
            } finally {
                applyingTheme = false;
            }
        }
        
        async function stressTest() {
            log('ğŸ”¥ å¼€å§‹å‹åŠ›æµ‹è¯•ï¼šå¿«é€Ÿåˆ‡æ¢ 50 æ¬¡', 'warn');
            const themes = ['light', 'dark', 'cat', 'dog'];
            
            for (let i = 0; i < 50; i++) {
                const theme = themes[i % themes.length];
                await testTheme(theme);
                await new Promise(resolve => setTimeout(resolve, 50)); // 50ms é—´éš”
            }
            
            log('âœ“ å‹åŠ›æµ‹è¯•å®Œæˆ', 'success');
        }
        
        async function concurrentTest() {
            log('ğŸ”¥ å¼€å§‹å¹¶å‘æµ‹è¯•ï¼šåŒæ—¶è§¦å‘ 10 æ¬¡', 'warn');
            const promises = [];
            
            for (let i = 0; i < 10; i++) {
                promises.push(testTheme('dark'));
            }
            
            await Promise.all(promises);
            log('âœ“ å¹¶å‘æµ‹è¯•å®Œæˆ', 'success');
        }
        
        // åˆå§‹åŒ–
        log('âœ“ æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
        log('â†’ ç‚¹å‡»æŒ‰é’®æµ‹è¯•ä¸»é¢˜åˆ‡æ¢', 'info');
    </script>
</body>
</html>

